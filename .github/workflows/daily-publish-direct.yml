name: å°çº¢ä¹¦å® ç‰©å†…å®¹è‡ªåŠ¨åŒ–ï¼ˆç›´æ¥å‘å¸ƒç‰ˆï¼‰

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤©æ—©ä¸Š6ç‚¹å’Œæ™šä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
on:
  schedule:
    # UTCæ—¶é—´22ç‚¹ = åŒ—äº¬æ—¶é—´æ¬¡æ—¥6ç‚¹ï¼ˆæ—©é—´å†…å®¹ï¼‰
    - cron: '0 22 * * *'
    # UTCæ—¶é—´12ç‚¹ = åŒ—äº¬æ—¶é—´20ç‚¹ï¼ˆæ™šé—´å†…å®¹ï¼‰
    - cron: '0 12 * * *'
  # æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:
    inputs:
      post_type:
        description: 'å‘å¸ƒç±»å‹ (morning/evening/both)'
        required: false
        default: 'both'
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªç”Ÿæˆä¸å‘å¸ƒï¼‰'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  TZ: Asia/Shanghai

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…Chromeå’ŒChromeDriver
      - name: å®‰è£…Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: å®‰è£…ChromeDriver
        uses: browser-actions/setup-chrome-driver@v1
        with:
          chrome-driver-version: stable

      # 4. éªŒè¯Chromeå®‰è£…
      - name: éªŒè¯Chromeå®‰è£…
        run: |
          google-chrome --version
          chromedriver --version

      # 5. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests

      # 6. é…ç½®ç¯å¢ƒå˜é‡
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "XIAOHONGSHU_COOKIE=${{ secrets.XIAOHONGSHU_COOKIE }}" >> $GITHUB_ENV
          echo "VOLCANO_API_KEY=${{ secrets.VOLCANO_API_KEY }}" >> $GITHUB_ENV
          echo "VOLCANO_API_SECRET=${{ secrets.VOLCANO_API_SECRET }}" >> $GITHUB_ENV

      # 7. ç”Ÿæˆå†…å®¹
      - name: ç”Ÿæˆæ—©é—´å® ç‰©å†…å®¹
        if: contains(github.event.inputs.post_type || 'both', 'morning')
        run: |
          echo "ğŸŒ… å¼€å§‹ç”Ÿæˆæ—©é—´å†…å®¹..."
          python scripts/content_generator.py --type morning

      - name: ç”Ÿæˆæ™šé—´å® ç‰©å†…å®¹
        if: contains(github.event.inputs.post_type || 'both', 'evening')
        run: |
          echo "ğŸŒ™ å¼€å§‹ç”Ÿæˆæ™šé—´å†…å®¹..."
          python scripts/content_generator.py --type evening

      # 8. ä¿å­˜è®°å½•
      - name: ä¿å­˜å‘å¸ƒè®°å½•
        run: |
          echo "ğŸ’¾ ä¿å­˜è®°å½•..."
          python scripts/save_records.py

      # 9. å‘å¸ƒåˆ°å°çº¢ä¹¦ï¼ˆå¦‚æœä¸æ˜¯æµ‹è¯•æ¨¡å¼ï¼‰
      - name: å‘å¸ƒåˆ°å°çº¢ä¹¦
        if: github.event.inputs.test_mode != 'true'
        run: |
          echo "ğŸš€ å¼€å§‹å‘å¸ƒåˆ°å°çº¢ä¹¦..."
          python scripts/github_publisher.py publish
        env:
          XIAOHONGSHU_COOKIE: ${{ secrets.XIAOHONGSHU_COOKIE }}

      # 10. æäº¤å†…å®¹åˆ°ä»“åº“
      - name: æäº¤ä»Šæ—¥å†…å®¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/
          git add data/records/
          git status
          if [ -n "$(git diff --cached --name-only)" ]; then
            git commit -m "ğŸ“ $(date +%Y-%m-%d) è‡ªåŠ¨æ›´æ–°å® ç‰©å†…å®¹"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:master
            echo "å†…å®¹å·²æäº¤åˆ°ä»“åº“"
          else
            echo "æ²¡æœ‰æ–°å†…å®¹éœ€è¦æäº¤"
          fi

      # 11. å‘é€å®Œæˆé€šçŸ¥
      - name: å‘é€å®Œæˆé€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å†…å®¹ç”Ÿæˆå¹¶å‘å¸ƒå®Œæˆ!"
          else
            echo "âŒ æµç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
