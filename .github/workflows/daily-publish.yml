name: å°çº¢ä¹¦å® ç‰©å†…å®¹è‡ªåŠ¨åŒ–

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤©æ—©ä¸Š6ç‚¹å’Œæ™šä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
on:
  schedule:
    # UTCæ—¶é—´22ç‚¹ = åŒ—äº¬æ—¶é—´æ¬¡æ—¥6ç‚¹ï¼ˆæ—©é—´å†…å®¹ï¼‰
    - cron: '0 22 * * *'
    # UTCæ—¶é—´12ç‚¹ = åŒ—äº¬æ—¶é—´20ç‚¹ï¼ˆæ™šé—´å†…å®¹ï¼‰
    - cron: '0 12 * * *'
  # æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:
    inputs:
      post_type:
        description: 'å‘å¸ƒç±»å‹ (morning/evening/both)'
        required: false
        default: 'both'
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸å®é™…å‘å¸ƒï¼‰'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  TZ: Asia/Shanghai

jobs:
  pet-content-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. é…ç½®ç¯å¢ƒå˜é‡
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}" >> $GITHUB_ENV
          echo "IMAGE_API_KEY=${{ secrets.IMAGE_API_KEY }}" >> $GITHUB_ENV
          echo "XIAOHONGSHU_COOKIE=${{ secrets.XIAOHONGSHU_COOKIE }}" >> $GITHUB_ENV

      # 5. ç”Ÿæˆæ—©é—´å†…å®¹
      - name: ç”Ÿæˆæ—©é—´å® ç‰©å†…å®¹
        if: contains(github.event.inputs.post_type || 'both', 'morning')
        id: generate_morning
        run: |
          echo "ğŸŒ… å¼€å§‹ç”Ÿæˆæ—©é—´å†…å®¹..."
          python scripts/content_generator.py --type morning
          echo "::set-output name=morning_success::true"

      # 6. ç”Ÿæˆæ™šé—´å†…å®¹
      - name: ç”Ÿæˆæ™šé—´å® ç‰©å†…å®¹
        if: contains(github.event.inputs.post_type || 'both', 'evening')
        id: generate_evening
        run: |
          echo "ğŸŒ™ å¼€å§‹ç”Ÿæˆæ™šé—´å†…å®¹..."
          python scripts/content_generator.py --type evening
          echo "::set-output name=evening_success::true"

      # 7. ä¿å­˜è®°å½•
      - name: ä¿å­˜å‘å¸ƒè®°å½•
        run: |
          echo "ğŸ’¾ ä¿å­˜è®°å½•..."
          python scripts/save_records.py

      # 8. æäº¤å†…å®¹åˆ°ä»“åº“
      - name: æäº¤ä»Šæ—¥å†…å®¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/
          git add data/records/
          git status
          if [ -n "$(git diff --cached --name-only)" ]; then
            git commit -m "ğŸ“ $(date +%Y-%m-%d) è‡ªåŠ¨æ›´æ–°å® ç‰©å†…å®¹"
            git push
            echo "å†…å®¹å·²æäº¤åˆ°ä»“åº“"
          else
            echo "æ²¡æœ‰æ–°å†…å®¹éœ€è¦æäº¤"
          fi

      # 9. å‘é€å®Œæˆé€šçŸ¥
      - name: å‘é€å®Œæˆé€šçŸ¥
        if: always()
        run: |
          echo "æ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
          echo "æ—©é—´å†…å®¹: ${{ steps.generate_morning.outputs.morning_success || 'skipped' }}"
          echo "æ™šé—´å†…å®¹: ${{ steps.generate_evening.outputs.evening_success || 'skipped' }}"
